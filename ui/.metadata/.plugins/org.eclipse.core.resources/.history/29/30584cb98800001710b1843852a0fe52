<%@page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<%@include file="/M/header.jsp"%>
<style type="text/css">

</style>
</head>
<body>
	<fieldset class="main_fieldset">
		<legend id="config_fieldset">
			<img class="head_img" src="/img/M/setting.svg">
			<span>Setting</span>
		</legend>
		<table>
			<thead>
				<tr>
					<th>phy</th>
					<th>interface</th>
					<th>driver</th>
					<th>chipset</th>
					<th>monitor</th>
				</tr>
			</thead>
			<tbody></tbody>
		</table>
	</fieldset>
</body>

<script type="text/javascript">
var config_id = '<%= HttpGet.get(request, "config_id", "")%>';

function bind_add_tag() {
	// tag 설정 추가
	$(".add_tag_img").click(function() {
		var c = $("#sample_tag").clone(true);
		c.find("input").val("");
		var $p2 = pN($(this), 2);
		var $p5 = pN($(this), 5);
		
		var tags = $p5.find("input[name=tags]");
		tags.val(parseInt(tags.val()) + 1);
		
		var $t = $p2.find(".tag_div");
		c.css({display:'none'});
		c.prependTo($t).show("slow");
		c.removeClass("hidden");
	});
}

function bind_del_tag() {
	$(".del_tag_img").click(function() {
		var $p10 = pN($(this), 10);
		var tags = $p10.find("input[name=tags]");
		tags.val(parseInt(tags.val()) - 1);
		
		var $p4 = pN($(this), 4);
		$p4.hide("slow", function() { $p4.remove(); });
	});
}

function bind_add_config() {
	// config 설정 추가
	$(".add_config_img").click(function() {
		var c = $("#sample_config").clone(true);
		c.find("input").val("");
		c.find(".tag_div").empty();
		var t = $(this).attr("target");
		c.css({display:'none'});
		// shooter or capture 종류 구분
		c.find("input[name=target]").val(t);
		c.find("input[name=tags]").val("0");
		c.prependTo($("#"+t)).slideDown("slow");
		c.removeClass("hidden");
	});
}

function bind_del_config() {
	$(".del_config_img").click(function() {
		var $p1 = pN($(this), 1);
		$p1.slideUp("slow", function() { $p1.remove(); });
	});
}

function bind_change_address() {
	$(".address").change(function() {
		var $p1 = pN($(this), 1);
		
		$p1.find(".addr").hide();
		
		var type = $(this).val();
		if (type == "any_addr") {
			$p1.find(".any_addr").show();
		} else if (type == "apsta") {
			$p1.find(".apsta").show();
		} else if (type == "addr1") {
			$p1.find(".addr1").show();
		} else if (type == "addr2") {
			$p1.find(".addr2").show();
		} else if (type == "addr3") {
			$p1.find(".addr3").show();
		} else if (type == "addr4") {
			$p1.find(".addr4").show();
		}
	});
}

function bind_all() {
	bind_add_tag();
	bind_del_tag();
	bind_add_config();
	bind_del_config();
	bind_change_address();
}

function build_config_list(target, list) {
	$.each(list, function(i, v){
		var c = $("#sample_config").clone(true);
		c.removeClass("hidden");
		c.find("input").val("");
		// shooter or capture 종류 구분
		c.find("input[name=target]").val(target);
		c.find("select[name=enable]").val(v.enable).change();
		c.find("input[name=desc]").val(v.desc);
		c.find("input[name=dwell]").val(v.dwell);
		c.find("input[name=channel]").val(v.channel);
		if (!_isnull(v.type) && !_isnull(v.subtype)) {
			var frame = v.type+""+parseInt(v.subtype).toString(16);
			c.find("select[name=frame]").val(frame).change();
		}
		if (!_isnull(v.fromds) && !_isnull(v.tods)) {
			var ds = v.fromds+""+v.tods;
			c.find("select[name=ds]").val(ds).change();
		}
		var addrtype = "";
		switch (_int(v.addrCount)) {
		case 1:
			c.find("input[name=addr1_da]").val(v.da);
			addrtype = "addr1";
			break;
		case 2:
			c.find("input[name=addr2_da]").val(v.da);
			c.find("input[name=addr2_sa]").val(v.sa);
			addrtype = "addr2";
			break;
		case 3:
			c.find("input[name=addr3_bssid]").val(v.bssid);
			c.find("input[name=addr3_da]").val(v.da);
			c.find("input[name=addr3_sa]").val(v.sa);
			addrtype = "addr3";
			break;
		case 4:
			c.find("input[name=addr4_ra]").val(v.ra);
			c.find("input[name=addr4_ta]").val(v.ta);
			c.find("input[name=addr4_da]").val(v.da);
			c.find("input[name=addr4_sa]").val(v.sa);
			addrtype = "addr4";
			break;
		default:
			if (!_isnull(v.anyAddr)) {
				c.find("input[name=any_addr]").val(v.anyAddr);
				addrtype = "any_addr";	
			}
			if (!_isnull(v.ap)) {
				c.find("input[name=ap]").val(v.ap);
				addrtype = "apsta";
			}
			if (!_isnull(v.sta)) {
				c.find("input[name=sta]").val(v.sta);
				addrtype = "apsta";
			}
		}
		c.find("select[name=address]").val(addrtype).change();
		
		var tag_div = c.find(".tag_div");
		tag_div.empty();
		c.find("input[name=tags]").val("0");
		if (!_isnull(v.taglist)) {
			c.find("input[name=tags]").val(v.taglist.length);
			$.each(v.taglist, function(k, t) {
				var ct = $("#sample_tag").clone(true);
				ct.removeClass("hidden");
				ct.find("input").val("");
				ct.find("input[name=tag_id]").val(t.id);
				ct.find("input[name=tag_length]").val(t.len);
				ct.find("input[name=tag_value]").val(t.data);
				ct.find("select[name=tag_type]").val(t.type);
				tag_div.append(ct);
			});
		}
		
		c.appendTo($("#"+target));
	});
}
$(document).ready(function() {
	$("#tabs").tabs();	
	$(".addr").hide();
	
	bind_all();
	
	$("#save_config").click(function() {
		var $config_name = $("#config_name");
		if ($config_name.val() == "") {
			pop("missing config name...", {
				focus: $config_name,
			});
			return;
		}
		
		$("#config_form input[name=tag_id]").each(function() {
			if ($(this).val() == "") {
				var $p10 = pN($(this), 10);
				var t = $p10.find("input[name=target]").val();
				var s = (t == "shooter") ? 0 : 1
				$("#tabs").tabs("option", "active", s);
				$(this).focus();
			}
		});
		
		$.post("add_config.jsp", $("#config_form").serialize())
			.done(function(result) {
				if (result.good == false) {
					pop("Error add config: "+result.cause);
					return;
				}
				else {
					pop("success registered config: "+$("#config_name").val(), {
						page: "/M/config_list.jsp"
					});
				}
		}, "json");
	});
	
	if (config_id != '') {
		$("#config_fieldset span").html("Edit Config");
		
		jQuery.ajax({
			url: "/get_config.jsp",
			data: {
				id: config_id,
				detail: true,
			},
			cache: false,
			dataType: "json",
			success: function(result) {
				if (result.good == false) {
					pop("Error loading for config.\n"+result.cause);
					return;
				}
				console.log(result);
				
				$("#config_id").val(result.id);
				$("#config_name").val(result.name);
				build_config_list("shooter", result.shooterXmlAirConfList);
				build_config_list("capture", result.captureXmlAirConfList);
				
			},
			error: function(e) {
				//ajax_err_handle(e);
				pop("Error loading for config.\nplease retry...");
			}
		});
	}
});
</script>
<%@include file="/M/footer.jsp"%>
</html>
